<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一个好鱼</title>
    <meta name="generator" content="VuePress 1.8.0">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.5b4dd3e6.css" as="style"><link rel="preload" href="/assets/js/app.29dba295.js" as="script"><link rel="preload" href="/assets/js/2.06d07068.js" as="script"><link rel="preload" href="/assets/js/11.ca41c290.js" as="script"><link rel="prefetch" href="/assets/js/10.5d625248.js"><link rel="prefetch" href="/assets/js/12.70386348.js"><link rel="prefetch" href="/assets/js/13.9bbe325a.js"><link rel="prefetch" href="/assets/js/14.fe4ac77b.js"><link rel="prefetch" href="/assets/js/15.fb2a8e7b.js"><link rel="prefetch" href="/assets/js/16.3d95a165.js"><link rel="prefetch" href="/assets/js/17.04aa0ffc.js"><link rel="prefetch" href="/assets/js/18.30da5bbe.js"><link rel="prefetch" href="/assets/js/3.6ee96839.js"><link rel="prefetch" href="/assets/js/4.09b76e67.js"><link rel="prefetch" href="/assets/js/5.bf141d85.js"><link rel="prefetch" href="/assets/js/6.f561f13c.js"><link rel="prefetch" href="/assets/js/7.5158432f.js"><link rel="prefetch" href="/assets/js/8.4b6d7937.js"><link rel="prefetch" href="/assets/js/9.f6942b24.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5b4dd3e6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">一个好鱼</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/zhhbinn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  关于
</a></div><div class="nav-item"><a href="https://github.com/zhhbinn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/posts/数据库/Mongoose的聚合函数.html" class="sidebar-link">Mongoose的聚合函数</a></li><li><a href="/posts/数据库/Sequelize入门.html" class="active sidebar-link">Sequelize入门</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#模型基础" class="sidebar-link">模型基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#表面推断" class="sidebar-link">表面推断</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#数据类型" class="sidebar-link">数据类型</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#列参数" class="sidebar-link">列参数</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#模型实例" class="sidebar-link">模型实例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#创建实例" class="sidebar-link">创建实例</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#更新实例" class="sidebar-link">更新实例</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#删除实例" class="sidebar-link">删除实例</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#重载实例" class="sidebar-link">重载实例</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#递增和递减整数值" class="sidebar-link">递增和递减整数值</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#模型查询" class="sidebar-link">模型查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#insert-查询" class="sidebar-link">insert 查询</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#select-查询" class="sidebar-link">&gt; select 查询</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#where-语句" class="sidebar-link">where 语句</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#update-查询" class="sidebar-link">update 查询</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#delete-查询" class="sidebar-link">delete 查询</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#批量创建" class="sidebar-link">批量创建</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#排序分组" class="sidebar-link">排序分组</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#限制分页" class="sidebar-link">限制分页</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#实用方法" class="sidebar-link">实用方法</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#模型查询-查找器" class="sidebar-link">模型查询（查找器）</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#获取器-设置器-虚拟字段" class="sidebar-link">获取器，设置器&amp;虚拟字段</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#获取器、设置器" class="sidebar-link">获取器、设置器</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#虚拟字段" class="sidebar-link">虚拟字段</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#验证与约束" class="sidebar-link">验证与约束</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#区别" class="sidebar-link">区别</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#允许-禁止-null" class="sidebar-link">允许/禁止 null</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#验证器" class="sidebar-link">验证器</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#原始查询" class="sidebar-link">原始查询</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#sequelize-query" class="sidebar-link">sequelize.query()</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#点属性和-nest-参数" class="sidebar-link">点属性和 nest 参数</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#替换" class="sidebar-link">替换</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#关联" class="sidebar-link">关联</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#三种关系" class="sidebar-link">三种关系：</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#四种关联类型" class="sidebar-link">四种关联类型：</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#一对一" class="sidebar-link">一对一</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#一对多" class="sidebar-link">一对多</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#多对多" class="sidebar-link">多对多</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#基本的涉及关联的查询" class="sidebar-link">基本的涉及关联的查询</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#关联别名" class="sidebar-link">关联别名</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#自定义外键" class="sidebar-link">自定义外键</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#添加到实例的特殊方法" class="sidebar-link">添加到实例的特殊方法</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#为什么关联是成对定义的" class="sidebar-link">为什么关联是成对定义的</a></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#创建引用非主键字段的关联" class="sidebar-link">创建引用非主键字段的关联</a></li></ul></li><li class="sidebar-sub-header"><a href="/posts/数据库/Sequelize入门.html#偏执表" class="sidebar-link">偏执表</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>移动端</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTML</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><blockquote><p>https://www.sequelize.com.cn/</p></blockquote> <h2 id="模型基础"><a href="#模型基础" class="header-anchor">#</a> 模型基础</h2> <h3 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h3> <blockquote><p>在内部,sequelize.define 调用 Model.init,因此两种方法本质上是等效的.</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Sequelize<span class="token punctuation">,</span> DataTypes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span><span class="token string">'sqlite::memory:'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
  <span class="token string">'User'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 在这里定义模型属性</span>
    firstName<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
      allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    lastName<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
      <span class="token comment">// allowNull 默认为 true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 这是其他模型参数</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// `sequelize.define` 会返回模型</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>User <span class="token operator">===</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Sequelize<span class="token punctuation">,</span> DataTypes<span class="token punctuation">,</span> Model <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sequelize</span><span class="token punctuation">(</span><span class="token string">'sqlite::memory'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

User<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 在这里定义模型属性</span>
    firstName<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
      allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    lastName<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
      <span class="token comment">// allowNull 默认为 true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 这是其他模型参数</span>
    sequelize<span class="token punctuation">,</span> <span class="token comment">// 我们需要传递连接实例</span>
    modelName<span class="token operator">:</span> <span class="token string">'User'</span><span class="token punctuation">,</span> <span class="token comment">// 我们需要选择模型名称</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 定义的模型是类本身</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>User <span class="token operator">===</span> sequelize<span class="token punctuation">.</span>models<span class="token punctuation">.</span>User<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div><h3 id="表面推断"><a href="#表面推断" class="header-anchor">#</a> 表面推断</h3> <blockquote><p>默认情况下,当未提供表名时,Sequelize 会自动将模型名复数并将其用作表名. 这种复数是通过称为 inflection 的库在后台完成的,因此可以正确计算不规则的复数(例如 person -&gt; people)</p></blockquote> <h3 id="数据类型"><a href="#数据类型" class="header-anchor">#</a> 数据类型</h3> <h3 id="列参数"><a href="#列参数" class="header-anchor">#</a> 列参数</h3> <h2 id="模型实例"><a href="#模型实例" class="header-anchor">#</a> 模型实例</h2> <p>假设模型是 User 类，模型都是 ES6 类，jane 为类的实例</p> <h3 id="创建实例"><a href="#创建实例" class="header-anchor">#</a> 创建实例</h3> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jane<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等于</span>
User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="默认值"><a href="#默认值" class="header-anchor">#</a> 默认值</h4> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'test'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="实例记录"><a href="#实例记录" class="header-anchor">#</a> 实例记录</h4> <div class="language-js extra-class"><pre class="language-js"><code>jane<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="更新实例"><a href="#更新实例" class="header-anchor">#</a> 更新实例</h3> <h4 id="赋值后调用"><a href="#赋值后调用" class="header-anchor">#</a> 赋值后调用</h4> <div class="language-js extra-class"><pre class="language-js"><code>jane<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="仅保存部分字段"><a href="#仅保存部分字段" class="header-anchor">#</a> 仅保存部分字段</h4> <div class="language-js extra-class"><pre class="language-js"><code>jane<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">{</span> fields<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="删除实例"><a href="#删除实例" class="header-anchor">#</a> 删除实例</h3> <div class="language-js extra-class"><pre class="language-js"><code>jane<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="重载实例"><a href="#重载实例" class="header-anchor">#</a> 重载实例</h3> <div class="language-js extra-class"><pre class="language-js"><code>jane<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="递增和递减整数值"><a href="#递增和递减整数值" class="header-anchor">#</a> 递增和递减整数值</h3> <div class="language-js extra-class"><pre class="language-js"><code>jane<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> by<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jane<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">{</span> age<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> year<span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="模型查询"><a href="#模型查询" class="header-anchor">#</a> 模型查询</h2> <h3 id="insert-查询"><a href="#insert-查询" class="header-anchor">#</a> insert 查询</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这可以限制 User 模型只设置 name，而不设置 age</span>
User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> fields<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="select-查询"><a href="#select-查询" class="header-anchor">#</a> &gt; select 查询</h3> <h4 id="直接读取整张表"><a href="#直接读取整张表" class="header-anchor">#</a> 直接读取整张表</h4> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select <span class="token operator">*</span> <span class="token keyword">from</span> User<span class="token punctuation">;</span>
</code></pre></div><h4 id="查询特定属性"><a href="#查询特定属性" class="header-anchor">#</a> 查询特定属性</h4> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  attributes<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span>'bar<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select foo<span class="token punctuation">,</span>bar <span class="token keyword">from</span> User<span class="token punctuation">;</span>

<span class="token comment">// 可以用嵌套数组来重命名属性</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  attributes<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">'bar'</span><span class="token punctuation">,</span><span class="token string">'qar'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select foo<span class="token punctuation">,</span>bar <span class="token constant">AS</span> qar <span class="token keyword">from</span> User<span class="token punctuation">;</span>

<span class="token comment">// 聚合函数 AVG，COUNT（行数），SUM，MIN，MAX</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  attributes<span class="token operator">:</span><span class="token punctuation">[</span>
    <span class="token string">'foo'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'COUNT'</span><span class="token punctuation">,</span>sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'hats'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'n_hats'</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select foo<span class="token punctuation">,</span><span class="token constant">COUNT</span><span class="token punctuation">(</span>cats<span class="token punctuation">)</span> <span class="token keyword">as</span> n_hats <span class="token keyword">from</span> User<span class="token punctuation">;</span>

<span class="token comment">// 有时,如果只想添加聚合,那么列出模型的所有属性可能会很麻烦</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  attributes<span class="token operator">:</span><span class="token punctuation">[</span>
    <span class="token string">'foo'</span><span class="token punctuation">,</span><span class="token string">'qar'</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'COUNT'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'hats'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'n_hats'</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 可以简写成</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  attributes<span class="token operator">:</span><span class="token punctuation">[</span>
    include<span class="token operator">:</span><span class="token punctuation">[</span>
      <span class="token punctuation">[</span>sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'COUNT'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'hats'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'n_hats'</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select foo<span class="token punctuation">,</span>qar<span class="token punctuation">,</span><span class="token constant">COUNT</span><span class="token punctuation">(</span>hats<span class="token punctuation">)</span> <span class="token constant">AS</span> n_hats <span class="token keyword">from</span> User<span class="token punctuation">;</span>

<span class="token comment">// 同时也可以排除一些属性</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  attributes<span class="token operator">:</span><span class="token punctuation">[</span>
    exclude<span class="token operator">:</span><span class="token punctuation">[</span>
      <span class="token string">'foo'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="where-语句"><a href="#where-语句" class="header-anchor">#</a> where 语句</h3> <h4 id="基础"><a href="#基础" class="header-anchor">#</a> 基础</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Op <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;sequelize&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 不显式指定，默认为相等</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span><span class="token number">2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select <span class="token operator">*</span> <span class="token keyword">from</span> User where id <span class="token operator">=</span> <span class="token number">2</span>

<span class="token comment">// 等同于</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>eq<span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">2</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 多个校验,不显式指定，默认为AND</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span><span class="token string">'1'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select <span class="token operator">*</span> <span class="token keyword">from</span> User where id <span class="token operator">=</span> <span class="token number">2</span> and name <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">;</span>

<span class="token comment">// 等同于</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>and<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span><span class="token string">'1'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 也可以or</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">{</span>
      id<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span>
      id<span class="token operator">:</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select <span class="token operator">*</span> <span class="token keyword">from</span> User where id <span class="token operator">=</span> <span class="token number">2</span> or id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// 当条件相同时，可以写成</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select <span class="token operator">*</span> <span class="token keyword">from</span> User where id <span class="token operator">=</span> <span class="token number">2</span> or id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="操作符"><a href="#操作符" class="header-anchor">#</a> 操作符</h4> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>and<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>a<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>b<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>or<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>a<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>b<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// eq,ne(!=),is,not,or,</span>

    <span class="token comment">// gt(&gt;),gte(&gt;=),lt(&lt;),lte(&lt;=),between,notBetween</span>

    <span class="token comment">// in,notIn,like,notLike,startsWith,endsWith,</span>

    id<span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>eq<span class="token punctuation">]</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>

      <span class="token comment">// &gt; ALL (SELECT 1)</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>all<span class="token punctuation">]</span><span class="token operator">:</span> sequelize<span class="token punctuation">.</span><span class="token function">literal</span><span class="token punctuation">(</span><span class="token string">'SELECT 1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// [Op.in]的等同写法</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span><span class="token punctuation">{</span>
    id<span class="token operator">:</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> select <span class="token operator">*</span> <span class="token keyword">from</span> User where <span class="token string">'User'</span><span class="token punctuation">.</span><span class="token string">'id'</span> <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="update-查询"><a href="#update-查询" class="header-anchor">#</a> update 查询</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    lastName<span class="token operator">:</span> <span class="token string">'aa'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    where<span class="token operator">:</span> <span class="token punctuation">{</span>
      lastName<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="delete-查询"><a href="#delete-查询" class="header-anchor">#</a> delete 查询</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    lastName<span class="token operator">:</span> <span class="token string">'aa'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除全部</span>
<span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  truncate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="批量创建"><a href="#批量创建" class="header-anchor">#</a> 批量创建</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// captains为创建后的结果数组</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Jack Sparrow'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'Davy Jones'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果要进行验证，必须手动配置validate: true，而create自带验证</span>
<span class="token keyword">const</span> Foo <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  bar<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    validate<span class="token operator">:</span> <span class="token punctuation">{</span>
      len<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这不会引发错误,两个实例都将被创建</span>
<span class="token keyword">await</span> Foo<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'abc123'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'name too long'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这将引发错误,不会创建任何内容</span>
<span class="token keyword">await</span> Foo<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'abc123'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'name too long'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  validate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// foo 和 bar 都不会是管理员.</span>
<span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> username<span class="token operator">:</span> <span class="token string">'foo'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> admin<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  fields<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="排序分组"><a href="#排序分组" class="header-anchor">#</a> 排序分组</h3> <h4 id="排序"><a href="#排序" class="header-anchor">#</a> 排序</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// DESC 降序  ASC 升序 如果省略方向,则默认升序</span>
User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  order<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 将转义 title 并针对有效方向列表进行降序排列</span>
    <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'DESC'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// 将按最大年龄进行升序排序</span>
    sequelize<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'max'</span><span class="token punctuation">,</span> sequelize<span class="token punctuation">.</span><span class="token function">col</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="分组"><a href="#分组" class="header-anchor">#</a> 分组</h4> <blockquote><p>分组和排序的语法相同,只是分组不接受方向作为数组的最后一个参数(不存在 ASC, DESC, NULLS FIRST 等)</p></blockquote> <blockquote><p>你还可以将字符串直接传递给 group,该字符串将直接(普通)包含在生成的 SQL 中. 请谨慎使用,请勿与用户生成的内容一起使用</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 生成 'GROUP BY name'</span>

Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> group<span class="token operator">:</span> <span class="token string">'name'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="限制分页"><a href="#限制分页" class="header-anchor">#</a> 限制分页</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 提取10个实例/行</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 跳过8个实例/行</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 跳过5个实例,然后获取5个实例</span>
Project<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> offset<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> limit<span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="实用方法"><a href="#实用方法" class="header-anchor">#</a> 实用方法</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//count</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">这有 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">await</span> Project<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个项目</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// max min sum</span>

<span class="token comment">//假设我们有三个用户,分别是10、5和40岁</span>

<span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 40</span>
<span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> age<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>lt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span>
<span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span>
<span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> age<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 10</span>
<span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 55</span>
<span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> where<span class="token operator">:</span> <span class="token punctuation">{</span> age<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 50</span>
</code></pre></div><h2 id="模型查询-查找器"><a href="#模型查询-查找器" class="header-anchor">#</a> 模型查询（查找器）</h2> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 根据主键查询一个条目</span>
User<span class="token punctuation">.</span><span class="token function">findbyPk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 找到第一个符合的条目</span>
User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 找或者创建。使用 defaults 参数来定义必须创建的内容. 如果 defaults 不包含每一列的值,则 Sequelize 将采用 where 的值(如果存在)</span>
User<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>user<span class="token punctuation">,</span> created<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOrCreate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span> username<span class="token operator">:</span> <span class="token string">'aaa'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  defaults<span class="token operator">:</span> <span class="token punctuation">{</span>
    job<span class="token operator">:</span> <span class="token string">'Technical Lead JavaScript'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 'aaa'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这可能是也可能不是 'Technical Lead JavaScript'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>created<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 指示此实例是否刚刚创建的布尔值</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>created<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这里肯定是 'Technical Lead JavaScript'</span>
<span class="token punctuation">}</span>

<span class="token comment">// 找并计数</span>
User<span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> count<span class="token punctuation">,</span> rows <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> Project<span class="token punctuation">.</span><span class="token function">findAndCountAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>like<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'foo%'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  offset<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  limit<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="获取器-设置器-虚拟字段"><a href="#获取器-设置器-虚拟字段" class="header-anchor">#</a> 获取器，设置器&amp;虚拟字段</h2> <h3 id="获取器、设置器"><a href="#获取器、设置器" class="header-anchor">#</a> 获取器、设置器</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  username<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> DateTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果直接使用this.username，将会无限循环，所以要使用getDataValue</span>
      <span class="token keyword">const</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> tmp <span class="token operator">?</span> tmp<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="虚拟字段"><a href="#虚拟字段" class="header-anchor">#</a> 虚拟字段</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> DataTypes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> User <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  firstName<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
  lastName<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
  fullName<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// VIRTUAL 字段不会导致数据表也存在此列</span>
    type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">VIRTUAL</span><span class="token punctuation">,</span>
    <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'不要尝试设置 `fullName` 的值!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="验证与约束"><a href="#验证与约束" class="header-anchor">#</a> 验证与约束</h2> <h3 id="区别"><a href="#区别" class="header-anchor">#</a> 区别</h3> <ul><li>验证是在纯 JS 中在 Sequelize 级别执行的检查。如果验证失败，则根本不会将 SQL 查询发送到数据库</li> <li>约束实在 SQL 级别定义的规则。如果约束检查失败，则数据库将引发错误，并且 Sequelize 会将错误转发给 JS。与验证不同的是，它执行了 SQL 查询</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>  username<span class="token operator">:</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span>DataTypes<span class="token punctuation">.</span><span class="token constant">TEXT</span><span class="token punctuation">,</span>
    allowNull<span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
    unique<span class="token operator">:</span><span class="token boolean">true</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="允许-禁止-null"><a href="#允许-禁止-null" class="header-anchor">#</a> 允许/禁止 null</h3> <ul><li>allowNull 检查是 Sequelize 中唯一由验证和约束混合而成的检查，因为：</li></ul> <blockquote><p>如果试图将 null 设置到不允许为 null 的字段,则将抛出 ValidationError ,而且 不会执行任何 SQL 查询
另外,在 sequelize.sync 之后,具有 allowNull: false 的列将使用 NOT NULL SQL 约束进行定义. 这样,尝试将值设置为 null 的直接 SQL 查询也将失败</p></blockquote> <h3 id="验证器"><a href="#验证器" class="header-anchor">#</a> 验证器</h3> <p>验证会在 create、update、save 时运行，也可以手动调用 validate()</p> <div class="language-js extra-class"><pre class="language-js"><code>  sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  bar<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
    validate<span class="token operator">:</span> <span class="token punctuation">{</span>
      is<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-z]+$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>          <span class="token comment">// 匹配这个 RegExp</span>
      is<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^[a-z]+$&quot;</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">// 与上面相同,但是以字符串构造 RegExp</span>
      not<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[a-z]+$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>         <span class="token comment">// 不匹配 RegExp</span>
      not<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^[a-z]+$&quot;</span><span class="token punctuation">,</span><span class="token string">'i'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 与上面相同,但是以字符串构造 RegExp</span>
      isEmail<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token comment">// 检查 email 格式 (foo@bar.com)</span>
      isUrl<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment">// 检查 url 格式 (http://foo.com)</span>
      isIP<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>               <span class="token comment">// 检查 IPv4 (129.89.23.1) 或 IPv6 格式</span>
      isIPv4<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment">// 检查 IPv4 格式 (129.89.23.1)</span>
      isIPv6<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment">// 检查 IPv6 格式</span>
      isAlpha<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token comment">// 只允许字母</span>
      isAlphanumeric<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>     <span class="token comment">// 将仅允许使用字母数字,因此 '_abc' 将失败</span>
      isNumeric<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>          <span class="token comment">// 只允许数字</span>
      isInt<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment">// 检查有效的整数</span>
      isFloat<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token comment">// 检查有效的浮点数</span>
      isDecimal<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>          <span class="token comment">// 检查任何数字</span>
      isLowercase<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment">// 检查小写</span>
      isUppercase<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment">// 检查大写</span>
      notNull<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>            <span class="token comment">// 不允许为空</span>
      isNull<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment">// 只允许为空</span>
      notEmpty<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>           <span class="token comment">// 不允许空字符串</span>
      equals<span class="token operator">:</span> <span class="token string">'specific value'</span><span class="token punctuation">,</span> <span class="token comment">// 仅允许 'specific value'</span>
      contains<span class="token operator">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span>          <span class="token comment">// 强制特定子字符串</span>
      notIn<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 检查值不是这些之一</span>
      isIn<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>   <span class="token comment">// 检查值是其中之一</span>
      notContains<span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>       <span class="token comment">// 不允许特定的子字符串</span>
      len<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>              <span class="token comment">// 仅允许长度在2到10之间的值</span>
      isUUID<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>                <span class="token comment">// 只允许 uuid</span>
      isDate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>             <span class="token comment">// 只允许日期字符串</span>
      isAfter<span class="token operator">:</span> <span class="token string">&quot;2011-11-05&quot;</span><span class="token punctuation">,</span>    <span class="token comment">// 仅允许特定日期之后的日期字符串</span>
      isBefore<span class="token operator">:</span> <span class="token string">&quot;2011-11-05&quot;</span><span class="token punctuation">,</span>   <span class="token comment">// 仅允许特定日期之前的日期字符串</span>
      max<span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span>                  <span class="token comment">// 仅允许值 &lt;= 23</span>
      min<span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span>                  <span class="token comment">// 仅允许值 &gt;= 23</span>
      isCreditCard<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>       <span class="token comment">// 检查有效的信用卡号</span>

      <span class="token comment">// 自定义验证器的示例:</span>
      <span class="token function">isEven</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Only even values are allowed!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">isGreaterThanOtherField</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>otherField<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Bar must be greater than otherField.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>如果要传递一个单个数组参数，请传递一个单长度的参数数组。例</p> <div class="language-js extra-class"><pre class="language-js"><code>isIn<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="allownull-与其他验证器的交互"><a href="#allownull-与其他验证器的交互" class="header-anchor">#</a> allowNull 与其他验证器的交互</h4> <ul><li><p>如果 allowNull:false，并且该值设置为 null，则将跳过所有的验证器，并抛出错误</p></li> <li><p>如果 allowNull:true，并且该值设置为 null，则仅会跳过内置验证器，而自定义验证器仍将运行</p></li> <li><p>可以通过设置 notNull 验证其来自定义 allowNull 的错误消息</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
User<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
      allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      validate<span class="token operator">:</span> <span class="token punctuation">{</span>
        notNull<span class="token operator">:</span> <span class="token punctuation">{</span>
          msg<span class="token operator">:</span> <span class="token string">'请输入你的名字'</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> sequelize <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="模型范围内的验证"><a href="#模型范围内的验证" class="header-anchor">#</a> 模型范围内的验证</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Place</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Place<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
    address<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
    latitude<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      validate<span class="token operator">:</span> <span class="token punctuation">{</span>
        min<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">90</span><span class="token punctuation">,</span>
        max<span class="token operator">:</span> <span class="token number">90</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    longitude<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      validate<span class="token operator">:</span> <span class="token punctuation">{</span>
        min<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">180</span><span class="token punctuation">,</span>
        max<span class="token operator">:</span> <span class="token number">180</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    sequelize<span class="token punctuation">,</span>
    validate<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">bothCoordsOrNone</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在这种简单的情况下,如果只给定了纬度或经度,而不是同时给出两者, 则不能验证对象</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>latitude <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>longitude <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Either both latitude and longitude, or neither!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>使用模型对象的上下文调用模型验证器方法,如果它们抛出错误,则认为失败,否则将通过. 这与自定义字段特定的验证器相同</p></blockquote> <blockquote><p>所收集的任何错误消息都将与字段验证错误一起放入验证结果对象中,其关键字以 validate 选项对象中验证方法失败的键命名. 即便在任何时候每种模型验证方法都只有一个错误消息,但它会以数组中显示为单个字符串的错误形式展示,以最大程度地提高与字段错误的一致性</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">'latitude'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Invalid number: latitude'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">'bothCoordsOrNone'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'Either both latitude and longitude, or neither!'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="原始查询"><a href="#原始查询" class="header-anchor">#</a> 原始查询</h2> <h3 id="sequelize-query"><a href="#sequelize-query" class="header-anchor">#</a> sequelize.query()</h3> <p>默认会返回 2 个参数，一个结果数组和一个包含元数据的对象</p> <blockquote><p>在不需要访问元数据的情况下,你可以传递一个查询类型来告诉后续如何格式化结果. 例如,对于一个简单的选择查询你可以做</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> QueryTypes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM `users`'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果传递模型，将会返回一个模型的实例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Callee 是模型定义. 这样你就可以轻松地将查询映射到预定义的模型</span>
<span class="token keyword">const</span> projects <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM projects'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  model<span class="token operator">:</span> Projects<span class="token punctuation">,</span>
  mapToModel<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 如果你有任何映射字段,则在此处传递 true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 现在,`projects` 的每个元素都是 Project 的一个实例</span>
</code></pre></div><h3 id="点属性和-nest-参数"><a href="#点属性和-nest-参数" class="header-anchor">#</a> 点属性和 nest 参数</h3> <p>设置 nest:true,可以将点属性展开变为嵌套对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> QueryTypes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> records <span class="token operator">=</span> <span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'select 1 as `foo.bar.baz`'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  nest<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>records<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;foo&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;bar&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;baz&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 没有使用的</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;foo.bar.baz&quot;</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="替换"><a href="#替换" class="header-anchor">#</a> 替换</h3> <ul><li>如果传递一个数组，<code>?</code>将按照它们在数组里出现的顺序被替换</li> <li>如果传递一个对象，<code>:key</code>将替换为该对象的键对应的值，如果对象包含在查询中找不到的键,则会抛出异常</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> QueryTypes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM projects WHERE status = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  replacements<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'active'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM projects WHERE status = :status'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  replacements<span class="token operator">:</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token string">'active'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//数组替换将自动处理,以下查询将搜索状态与值数组匹配的项目.</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> QueryTypes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'sequelize'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> sequelize<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM projects WHERE status IN(:status)'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  replacements<span class="token operator">:</span> <span class="token punctuation">{</span> status<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'active'</span><span class="token punctuation">,</span> <span class="token string">'inactive'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  type<span class="token operator">:</span> QueryTypes<span class="token punctuation">.</span><span class="token constant">SELECT</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="关联"><a href="#关联" class="header-anchor">#</a> 关联</h2> <h3 id="三种关系"><a href="#三种关系" class="header-anchor">#</a> 三种关系：</h3> <ul><li>一对一</li> <li>一对多</li> <li>多对多</li></ul> <h3 id="四种关联类型"><a href="#四种关联类型" class="header-anchor">#</a> 四种关联类型：</h3> <ul><li>HasOne</li> <li>BelongsTo</li> <li>HasMany</li> <li>BelongsToMany</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">A</span> <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">B</span> <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//A有一个B，外键在目标模型B中定义</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//A属于B，外键在源模型A中定义</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//A有多个B，外键在目标模型B中定义</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> through<span class="token operator">:</span> <span class="token string">'C'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//A属于多个B，通过C联结</span>
</code></pre></div><h3 id="一对一"><a href="#一对一" class="header-anchor">#</a> 一对一</h3> <div class="language-js extra-class"><pre class="language-js"><code>Foo<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>Bar<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  onDelete<span class="token operator">:</span> <span class="token string">'RESTRICT'</span><span class="token punctuation">,</span>
  onUpdate<span class="token operator">:</span> <span class="token string">'RESTRICT'</span><span class="token punctuation">,</span> <span class="token comment">//可用的参数为 RESTRICT, CASCADE, NO ACTION, SET DEFAULT 和 SET NULL</span>
  foreignKey<span class="token operator">:</span> <span class="token string">'myFooId'</span><span class="token punctuation">,</span> <span class="token comment">//自定义外键</span>
  allowNull<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//设置为强制性关联</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Bar<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>Foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="一对多"><a href="#一对多" class="header-anchor">#</a> 一对多</h3> <div class="language-js extra-class"><pre class="language-js"><code>Team<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Player<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  foreignKey<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'teamId'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Player<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>Team<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="多对多"><a href="#多对多" class="header-anchor">#</a> 多对多</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Movie <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'Movie'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Actor <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'Actor'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Movie<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Actor<span class="token punctuation">,</span> <span class="token punctuation">{</span> through<span class="token operator">:</span> <span class="token string">'ActorMovies'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Actor<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Movie<span class="token punctuation">,</span> <span class="token punctuation">{</span> through<span class="token operator">:</span> <span class="token string">'ActorMovies'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当联结表的模型中不存在主键时，belongsToMany 将创建一个唯一键，可以使用 uniqueKey 参数覆盖此唯一键名</p> <div class="language-js extra-class"><pre class="language-js"><code>Project<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  through<span class="token operator">:</span> UserProjects<span class="token punctuation">,</span>
  uniqueKey<span class="token operator">:</span> <span class="token string">'my_custom_unique'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="基本的涉及关联的查询"><a href="#基本的涉及关联的查询" class="header-anchor">#</a> 基本的涉及关联的查询</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这是用于以下示例的模型的设置</span>
<span class="token keyword">const</span> Ship <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
  <span class="token string">'ship'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
    crewCapacity<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    amountOfSails<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> timestamps<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Captain <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
  <span class="token string">'captain'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span>
    skillLevel<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      validate<span class="token operator">:</span> <span class="token punctuation">{</span> min<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> timestamps<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
Captain<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>Ship<span class="token punctuation">)</span><span class="token punctuation">;</span>
Ship<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>Captain<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="预先加载、延迟加载"><a href="#预先加载、延迟加载" class="header-anchor">#</a> 预先加载、延迟加载</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 延迟加载</span>
<span class="token keyword">const</span> awesomeCaptain <span class="token operator">=</span> <span class="token keyword">await</span> Captain<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'Jack Sparrow'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取有关他的 ship 的信息</span>
<span class="token keyword">const</span> hisShip <span class="token operator">=</span> <span class="token keyword">await</span> awesomeCaptain<span class="token punctuation">.</span><span class="token function">getShip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//预先加载</span>
<span class="token keyword">const</span> awesomeCaptain <span class="token operator">=</span> <span class="token keyword">await</span> Captain<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'Jack'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  include<span class="token operator">:</span> Ship<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Amount of Sails:'</span><span class="token punctuation">,</span> awesomeCaptain<span class="token punctuation">.</span>ship<span class="token punctuation">.</span>amountOfSails<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="关联别名"><a href="#关联别名" class="header-anchor">#</a> 关联别名</h3> <div class="language-js extra-class"><pre class="language-js"><code>Ship<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>Captain<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'leader'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="自定义外键"><a href="#自定义外键" class="header-anchor">#</a> 自定义外键</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这将在Ship中创建bossId外键</span>
Ship<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>Captain<span class="token punctuation">,</span> <span class="token punctuation">{</span> foreignKey<span class="token operator">:</span> <span class="token string">'bossId'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="添加到实例的特殊方法"><a href="#添加到实例的特殊方法" class="header-anchor">#</a> 添加到实例的特殊方法</h3> <h4 id="foo-hasone-bar"><a href="#foo-hasone-bar" class="header-anchor">#</a> Foo.hasOne(Bar)</h4> <ul><li>fooInstance.getBar()</li> <li>fooInstance.setBar()</li> <li>fooInstance.createBar()</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">await</span> Foo<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'the-foo'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bar1 <span class="token operator">=</span> <span class="token keyword">await</span> Bar<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'some-bar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bar2 <span class="token operator">=</span> <span class="token keyword">await</span> Bar<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'another-bar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">getBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//null</span>
<span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">setBar</span><span class="token punctuation">(</span>bar1<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">getBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//some-bar</span>
<span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">createBar</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'yet'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> newlyAssociatedBar <span class="token operator">=</span> <span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">getBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>newlyAssociatedBar<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//'yet'</span>
<span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">setBar</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">getBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//null</span>
</code></pre></div><h4 id="foo-belongsto-bar"><a href="#foo-belongsto-bar" class="header-anchor">#</a> Foo.belongsTo(Bar)</h4> <p>来自 Foo.hasOne(Bar) 的相同内容:</p> <ul><li>fooInstance.getBar()</li> <li>fooInstance.setBar()</li> <li>fooInstance.createBar()</li></ul> <h4 id="foo-hasmany-bar"><a href="#foo-hasmany-bar" class="header-anchor">#</a> Foo.hasMany(Bar)</h4> <ul><li>fooInstance.getBars()</li> <li>fooInstance.countBars()</li> <li>fooInstance.hasBar()</li> <li>fooInstance.hasBars()</li> <li>fooInstance.setBars()</li> <li>fooInstance.addBar()</li> <li>fooInstance.addBars()</li> <li>fooInstance.removeBar()</li> <li>fooInstance.removeBars()</li> <li>fooInstance.createBar()</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token keyword">await</span> Foo<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'the-foo'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bar1 <span class="token operator">=</span> <span class="token keyword">await</span> Bar<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'some-bar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bar2 <span class="token operator">=</span> <span class="token keyword">await</span> Bar<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'another-bar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">getBars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//[]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">countBars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//0</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">hasBar</span><span class="token punctuation">(</span>bar1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//false</span>
<span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">addBars</span><span class="token punctuation">(</span><span class="token punctuation">[</span>bar1<span class="token punctuation">,</span> bar2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">countBars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//2</span>
<span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">addBar</span><span class="token punctuation">(</span>bar1<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">countBars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//2</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">hasBar</span><span class="token punctuation">(</span>bar1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span>
<span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">removeBar</span><span class="token punctuation">(</span>bar2<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">countBars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//1</span>
<span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">createBar</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'yet-another-bar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">countBars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">setBars</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 取消关联所有先前关联的 Bars</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">await</span> foo<span class="token punctuation">.</span><span class="token function">countBars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
</code></pre></div><h4 id="foo-belongstomany-bar-through-baz"><a href="#foo-belongstomany-bar-through-baz" class="header-anchor">#</a> Foo.belongsToMany(Bar,{through:Baz})</h4> <p>来自 Foo.hasMany(Bar) 的相同内容:</p> <ul><li>fooInstance.getBars()</li> <li>fooInstance.countBars()</li> <li>fooInstance.hasBar()</li> <li>fooInstance.hasBars()</li> <li>fooInstance.setBars()</li> <li>fooInstance.addBar()</li> <li>fooInstance.addBars()</li> <li>fooInstance.removeBar()</li> <li>fooInstance.removeBars()</li> <li>fooInstance.createBar()</li></ul> <h3 id="为什么关联是成对定义的"><a href="#为什么关联是成对定义的" class="header-anchor">#</a> 为什么关联是成对定义的</h3> <blockquote><p>当在两个模型之间定义了 Sequelize 关联时,只有 源 模型 知晓关系. 因此,例如,当使用 Foo.hasOne(Bar)(当前,Foo 是源模型,而 Bar 是目标模型)时,只有 Foo 知道该关联的存在. 这就是为什么在这种情况下,如上所示,Foo 实例获得方法 getBar(), setBar() 和 createBar() 而另一方面,Bar 实例却没有获得任何方法.</p></blockquote> <blockquote><p>类似地,对于 Foo.hasOne(Bar),由于 Foo 了解这种关系,我们可以像 Foo.findOne({ include: Bar }) 中那样执行预先加载,但不能执行 Bar.findOne({ include: Foo }).</p></blockquote> <blockquote><p>因此,为了充分发挥 Sequelize 的作用,我们通常成对设置关系,以便两个模型都 互相知晓.</p></blockquote> <h3 id="创建引用非主键字段的关联"><a href="#创建引用非主键字段的关联" class="header-anchor">#</a> 创建引用非主键字段的关联</h3> <p>ORM 允许定义一个关联，该关联使用另一个字段而不是主键字段来建立关联。该字段必须对此具有唯一的约束。</p> <p>** 外键在源模型上，字段对应 targetKey，外键在目标模型上，字段对应 sourceKey **</p> <h4 id="对于-belongsto-关系"><a href="#对于-belongsto-关系" class="header-anchor">#</a> 对于 belongsTo 关系</h4> <blockquote><p>外键在源模型上</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 这将在源模型(Ship)中创建一个名为 `captainName` 的外键,</span>
<span class="token comment">// 该外键引用目标模型(Captain)中的 `name` 字段.</span>
Ship<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>Captain<span class="token punctuation">,</span> <span class="token punctuation">{</span> targetKey<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span> foreignKey<span class="token operator">:</span> <span class="token string">'captainName'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="对于-hasone-和-hasmany-关系"><a href="#对于-hasone-和-hasmany-关系" class="header-anchor">#</a> 对于 hasOne 和 hasMany 关系</h4> <blockquote><p>可以将完全相同的想法应用于 hasOne 和 hasMany 关联,但是在定义关联时,我们提供了 sourceKey,而不是提供 targetKey. 这是因为与 belongsTo 不同,hasOne 和 hasMany 关联将外键保留在目标模型上</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Foo <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
  <span class="token string">'foo'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> timestamps<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Bar <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
  <span class="token string">'bar'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span><span class="token punctuation">,</span> unique<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> timestamps<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Baz <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
  <span class="token string">'baz'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> summary<span class="token operator">:</span> DataTypes<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> timestamps<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
Foo<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>Bar<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceKey<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span> foreignKey<span class="token operator">:</span> <span class="token string">'fooName'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Bar<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Baz<span class="token punctuation">,</span> <span class="token punctuation">{</span> sourceKey<span class="token operator">:</span> <span class="token string">'title'</span><span class="token punctuation">,</span> foreignKey<span class="token operator">:</span> <span class="token string">'barTitle'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [...]</span>
<span class="token keyword">await</span> Bar<span class="token punctuation">.</span><span class="token function">setFoo</span><span class="token punctuation">(</span><span class="token string">&quot;Foo's Name Here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> Baz<span class="token punctuation">.</span><span class="token function">addBar</span><span class="token punctuation">(</span><span class="token string">&quot;Bar's Title Here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="对于-belongstomany-关系"><a href="#对于-belongstomany-关系" class="header-anchor">#</a> 对于 belongsToMany 关系</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//有四种情况需要考虑：</span>

<span class="token comment">//我们可能希望使用默认的主键为 Foo 和 Bar 进行多对多关系：</span>
<span class="token comment">// 这将创建具有字段 `fooId` 和 `barID` 的联结表 `foo_bar`.</span>

Foo<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Bar<span class="token punctuation">,</span> <span class="token punctuation">{</span> through<span class="token operator">:</span> <span class="token string">'foo_bar'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//我们可能希望使用默认主键 Foo 的多对多关系,但使用 Bar 的不同字段：</span>
<span class="token comment">// 这将创建具有字段 `fooId` 和 `barTitle` 的联结表 `foo_bar`.</span>

Foo<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Bar<span class="token punctuation">,</span> <span class="token punctuation">{</span> through<span class="token operator">:</span> <span class="token string">'foo_bar'</span><span class="token punctuation">,</span> targetKey<span class="token operator">:</span> <span class="token string">'title'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//我们可能希望使用 Foo 的不同字段和 Bar 的默认主键进行多对多关系：</span>
<span class="token comment">// 这将创建具有字段 `fooName` 和 `barId` 的联结表 `foo_bar`.</span>

Foo<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Bar<span class="token punctuation">,</span> <span class="token punctuation">{</span> through<span class="token operator">:</span> <span class="token string">'foo_bar'</span><span class="token punctuation">,</span> sourceKey<span class="token operator">:</span> <span class="token string">'name'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//我们可能希望使用不同的字段为 Foo 和 Bar 使用多对多关系：</span>
<span class="token comment">// 这将创建带有字段 `fooName` 和 `barTitle` 的联结表 `foo_bar`.</span>

Foo<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Bar<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  through<span class="token operator">:</span> <span class="token string">'foo_bar'</span><span class="token punctuation">,</span>
  sourceKey<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>
  targetKey<span class="token operator">:</span> <span class="token string">'title'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>在 sourceKey 和 targetKey 之间做出决定的技巧只是记住每个关系在何处放置其外键. 如本指南开头所述：</p></blockquote> <blockquote><p>A.belongsTo(B) 将外键保留在源模型中(A),因此引用的键在目标模型中,因此使用了 targetKey.</p></blockquote> <blockquote><p>A.hasOne(B) 和 A.hasMany(B) 将外键保留在目标模型(B)中,因此引用的键在源模型中,因此使用了 sourceKey.</p></blockquote> <blockquote><p>A.belongsToMany(B) 包含一个额外的表(联结表),因此 sourceKey 和 targetKey 均可用,其中 sourceKey 对应于 A(源)中的某个字段而 targetKey 对应于 B(目标)中的某个字段.</p></blockquote> <h2 id="偏执表"><a href="#偏执表" class="header-anchor">#</a> 偏执表</h2> <blockquote><p>一个 paranoid 表是一个被告知删除记录时不会真正删除它的表.反而一个名为 deletedAt 的特殊列会将其值设置为该删除请求的时间戳</p></blockquote> <blockquote><p>这意味着偏执表会执行记录的 软删除,而不是 硬删除</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Post</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Post<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token comment">/* 这是属性 */</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    sequelize<span class="token punctuation">,</span>
    paranoid<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

    <span class="token comment">// 如果要为 deletedAt 列指定自定义名称</span>
    deletedAt<span class="token operator">:</span> <span class="token string">'destroyTime'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除</span>
<span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// UPDATE &quot;posts&quot; SET &quot;deletedAt&quot;=[timestamp] WHERE &quot;deletedAt&quot; IS NULL AND &quot;id&quot; = 1</span>

<span class="token comment">// 如果你确实想要硬删除,并且模型是 paranoid,则可以使用 force: true 参数强制执行：</span>
<span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  force<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// DELETE FROM &quot;posts&quot; WHERE &quot;id&quot; = 1</span>

<span class="token comment">// 要恢复软删除的记录,可以使用 restore 方法,该方法在静态版本和实例版本中都提供</span>
<span class="token comment">// 我们创建一个帖子,对其进行软删除,然后将其还原</span>
<span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'test'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>post <span class="token keyword">instanceof</span> <span class="token class-name">Post</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
<span class="token keyword">await</span> post<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'soft-deleted!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> post<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'restored!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 展示静态 `restore` 方法的示例</span>
<span class="token comment">// 恢复每个 likes 大于 100 的软删除的帖子</span>
<span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    likes<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>Op<span class="token punctuation">.</span>gt<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 其他查询行为</span>
<span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果 ID 123 的记录被软删除,则将返回 `null`</span>
<span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> paranoid<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这将检索记录</span>

<span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这将不会检索软删除的记录</span>

<span class="token keyword">await</span> Post<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span> foo<span class="token operator">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  paranoid<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这还将检索软删除的记录</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/posts/数据库/Mongoose的聚合函数.html" class="prev">
        Mongoose的聚合函数
      </a></span> <span class="next"><a href="/posts/服务端/Puppeteer连接池.html">
        Puppeteer连接池
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.29dba295.js" defer></script><script src="/assets/js/2.06d07068.js" defer></script><script src="/assets/js/11.ca41c290.js" defer></script>
  </body>
</html>
